## Логгирование системы

(на с4 не вижу смысла отмечать, опишу тут, удобнее)

В логгер сервисов использующих SDK OpenTelemetry необходимо обязательно прокинуть traceID, чтобы мапить события и трейсы в Grafana на уровне Loki и Tempo.

Какие логи необходимо собирать (предлагается JSON в stdout и в OTEL LogExporter):

- Access logs (INFO) - для всех сервисов экспортирующих свой АПИ на уровне HTTP Controller с dependecy injection в контекст операций Service и Repository уровней. Уже на этом уровне можно извлекать userEmail при tokenIntrospect и энкапсулировать в трейс/лог.
- Injected Logs (порождается контекстом Access события) -  Eсли операция порождает отправку события в Message Bus, то логгируем detailed event на уровне DEBUG и легкий INFO лог об успешном запуске события с его status.
- Detailed HTTP Request/Response (DEBUG) - логгирование запросов с детализацией для отладки в dev окружении.
- HTTP Status code `400 <= x < 500` (WARN) - уровень операций результат, которых требует внимания. Например, пользователь (потенциальный абьюзер АПИ, пытается получить доступ к ресурсам вне его зон доступа (403 Forbidden)).
- HTTP Status code `500 <= x` (ERROR) - журналирование внутренних ошибок системы, для отладки некореектной работы интеграций, клиентов (Postgres, RabbitMQ)
- Postgres Logs (встроенные на уровне INFO) - позволит отследить неполадки в работе при расследовании инцидентов.
- RabbitMQ Logs (встроенные на уровне INFO) - позволит отследить неполадки в работе при расследовании инцидентов.

## Мотивация

Логгирование - важнейший компонент любой программной системы, обеспечивающий различные преимущества, повышающие производительность, безопасность и ремонтопригодность системы. Вот основные причины, по которым логирование необходимо:

1. Отладка и устранение неполадок
Ведение логов служит ценным инструментом для выявления и диагностики проблем в приложении. При возникновении проблем логи предоставляют подробную историю событий, приведших к сбою, что позволяет разработчикам более точно определить первопричину. Без ведения логов поиск и устранение неисправностей превращается в игру в угадайку, часто требующую применения методов проб и ошибок для решения проблем.

2. Мониторинг и анализ производительности
Логи позволяют отслеживать производительность приложений в режиме реального времени, фиксируя такие показатели, как время отклика, использование ресурсов и количество ошибок. Эти данные позволяют разработчикам выявлять узкие места и оптимизировать производительность системы, обеспечивая бесперебойную работу пользователей. Постоянный мониторинг с помощью логов также помогает поддерживать общее состояние системы, предупреждая администраторов о любых нарушениях или снижении производительности.

3. Соблюдение норм и аудит
Во многих отраслях промышленности соблюдение нормативных требований имеет решающее значение. Ведение логов обеспечивает полную запись действий пользователей, системных событий и доступа к данным, что очень важно для целей аудита. Такая подробная документация помогает организациям продемонстрировать, что они работают безопасно и в соответствии с требованиями законодательства.

4. Мониторинг безопасности
Логи играют важную роль в обеспечении безопасности, отслеживая попытки аутентификации, доступ к конфиденциальным ресурсам и другие события, связанные с безопасностью. Эта информация помогает обнаружить несанкционированный доступ или потенциальные нарушения, что позволяет своевременно реагировать на угрозы безопасности. Анализируя данные логов, организации могут повысить уровень своей безопасности и снизить риски, связанные с киберугрозами.

5. Централизованное управление информацией
Централизованные системы управления логами объединяют логи из различных источников в ИТ-среде, обеспечивая видимость всех операций. Такое объединение упрощает процесс мониторинга и анализа логов, позволяя ИТ-командам более эффективно сотрудничать и оперативно реагировать на инциденты. Она уменьшает шум, создаваемый большими объемами логов, позволяя пользователям соотносить события из разных систем.

В первую очередь логирование и трейсинг необходимо настроить для сервисов написанных самой командой (все 3 АПИ сервиса), так как разрабатываемые продукты всегда (99.9% случаев) содержат баги, ошибки, проблемы оптимизации, которые не возможно предугадать заранее. Инфрастурктурные компоненты, такие как Postgres или RabbitMQ, наоборот не требуют значительных вложений и бдительности, так как их код постоянно модерируется и улучшается большими комьюнити, то сводит ошибки в работе к нулю.

## Предлагаемое решение

Как и в решении с трейсингом предлагается исполбзовать уже задействованые ранее SDK OpenTelemetry для пуша логов в OpenTelemetry Collector.

Коллектор в свою очередь следует настроить на экспорт логов в Loki, который будет data source для Grafana.

Так как размещение Grafana предложено во внутреннем контуре организации и будет настроена аутентификация через Identity Provider самой организации, то безопасность будет регулироваться выдачей прав на доступы к Grafana, и будет предоставляться как разработчикам, так и команде поддержки. Внедрение полей с паролями и токенами пользователей в log span не рекомендуется даже на DEBUG уровне, поэтому какого-либо обезличивания передоваемой информации не предполагается, чтобы не затруднять процесс поддержки и разработки.

В целях продажи накопленной телеметрии данных о действиях пользователей, необходимо проводить анонимизацию поля userEmail в контектах логов. Это можно выполнить в процессе выгрузки Timeseries данных.

В рамках Loki хранение может быть очень гибким, всё зависит от гибкости руководства и нужд аудита по безопасности. Для начального этапа рекомендуется держать недельный интервал с retention policy в середине недели (вторник, среда).

Необходимый размер хранилища для логов оценить не возможно без обкатки "на живую". В крупных K8s системах размер логов может достигать до нескольких терабайт в неделю, что до нашего случая, то здесь будет существенную роль играть сезонность наплва пользователей и этапы расширения бизнеса.

Алертинг по логам стоит настраивать на данном этапе исключительно для профилактики безопасности. Например, установить отстрел алерта по логам уровня WARN с рейтом превышающим норму для единичного User scenario.

Спам логов не планируется, так как предлагается на входной зоне системы установить API Gateway (APISIX), который позволит зарегулировать Rate Limits и DDOS prevention для зоны API.