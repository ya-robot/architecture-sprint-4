## Мотивация

Мониторинг инфраструктуры позволяет организациям отслеживать состояние своих систем и сетей в режиме реального времени, что дает им возможность обнаружить потенциальные проблемы до того, как они перерастут в серьезные сбои.

## Выбор подхода к мониторингу

Для полноценного мониторинга системы такого плана как «Александрит» следует внимательно следить не только за
опытом пользователей ErrorRate, Latency, но и за использованием ресурсов системы. Это в первую очередь позволит с балансировать затраты на облачный хостинг, путём снижения запрашиваемых ресурсов у провайдера в тех сервисах и инфраструктуре, где они явно превышают текущий пиковый уровень. Поэтому следует на всех уровнях системы предусмотреть сбор метрик уровня 4GS.

Из списка доступных метрик следует обязательно использовать метрики отражающие утилизацию CPU, RAM, Storage. Это поможет установить алертинг по квотам потребляемых ресурсов, понять сезонность и динамику нагрузок, а также настроить автоскейлинг, для повышения доступности системы.

Метрики подходящие под данную задачу (из приведенного списка):

- CPU % for shop API
- CPU % for CRM API
- CPU % for MES API
- Memory Utilisation for shop API
- Memory Utilisation for CRM API
- Memory Utilisation for MES API
- Memory Utilisation for shop db instance
- Memory Utilisation for MES db instance
- Size of S3 storage
- Size of shop db instance
- Size of MES db instance

Для контроля User Experience Demands, определения сегментов (раутов) внедрения Кэширования, тюнинга Rate Limiter и таймаутов, следует следить за метриками по RPS(by route), Error(by route), Latency(by route), ErrRate(by route). Империческим путём можно установить приемлемый уровень ошибок (500) и настроить алертинг на показатели, превышающие заданные пределы.

Метрики подходящие под данную задачу (из приведенного списка):

- Number of requests (RPS) for internet shop API
- Number of requests (RPS) for CRM API
- Number of requests (RPS) for MES API
- Number of requests (RPS) per user for internet shop API
- Number of requests (RPS) per user for CRM API
- Number of requests (RPS) per user for MES API
- Response time (latency) for shop API
- Response time (latency) for CRM API
- Response time (latency) for MES API
- Number of HTTP 200 for shop API
- Number of HTTP 200 for CRM API
- Number of HTTP 200 for MES API
- Number of HTTP 500 for shop API
- Number of HTTP 500 for CRM API
- Number of HTTP 500 for MES API
- Number of HTTP 500 for shop API
- Number of simultanious sessions for shop API
- Number of simultanious sessions for CRM API
- Number of simultanious sessions for MES API

Опционально (на начальных этапах не критично) можно также использовать данные об HTTP Body byte size параметре, чтобы
иметь в виду узкие места, оптимизация размера пакетов которых позволит улучшить пользовательский опыт и нагрузку на систему:

- Kb tranferred (received) for shop API
- Kb tranferred (received) for CRM API
- Kb tranferred (received) for MES API
- Kb provided (sent) for shop API
- Kb provided (sent) for CRM API
- Kb provided (sent) for MES API

Критически важным является мониторинг инфрасруктуры, в данном случае инстансы Postgres и RabbitMQ. Тут следует внимательно следить за потребляемой памятью, connection lifecycle (Postgres), transactions rollback/idle (Postgres), message pending/proccessed (RabbitMQ), slow consumers (RabbitMQ).

Метрики подходящие под данную задачу (из приведенного списка и *new):

- Number of dead-letter-exchange letters in RabbitMQ
- Number of message in flight in RabbitMQ
- Number of connections for shop db instance
- Number of connections for MES db instance
- *Transaction statuses (count) for Postgres
- *Connection lifecycle (idle, in transaction, closed, recycled) for Postgres
- *Number of messages pending/processed ++/-- by topic in RabbitMQ
- *Slow consumers in RabbitMQ

Для всех метрик вводимых в мониторинг следует добавить лейблинг по vm_id, server_id. Чтобы определить на какую виртуальную машину и инстанс приложения приходится метрика.

## План действий

1. Запуск инфрастурктуры для сбора метрик
    - OpenTelemetry Collector (standalone mode)
    - Prometheus + DB + Alert Manger
    - Grafana (настройка импорта из Pormetheus)
2. Настройка экспорта метрик с сервисов (expose prometheus :80/metrics) и инфраструктуры(есть "из коробки" для Postgres и RabbitMQ)
3. Настройка расписания и правил опроса сервисов prometheus compatible на OpenTelemetry Collector
4. Настройка расписания и правил опроса OpenTelemetry export метрик на Pormetheus
5. Создание дашбордов на Grafana по выбранным метрикам
6. Создание Alert Rules для Alert Manager и нотификации (напр. Telegram)